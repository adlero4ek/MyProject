functions:
  # Пример вызова
  # $eval($FUNCTIONS.get_account,{"username": "v.lebedev", "accounts": $DICTIONARIES."accounts".parameters})
  get_account: >
    (
      $username := $.username;
      $accounts := $.accounts;
      $acc_link := "https://team.romashkagroup.ru/profile/" & $username;
      $type($username)="string"
      ?   (
          $full_account := $accounts[name=$username];
          $count($full_account) = 1
          ?   (
              $type($full_account.title)="string"
              ?
              $merge([$full_account, {"error" : false, "acc_link": $acc_link}])
              :
              {
                  "name": $username,
                  "title": $username,
                  "bu": "Наименование БЮ неопределенно",
                  "error" : true
              };
              )
          : $count($full_account) > 1
            ?
              $full_account.(
                $type($.bu) = "string"
                ? $merge([$, {"error" : false, "acc_link": $acc_link}])
              )
            :
              {
                "name": "Аккаунт не указан",
                "title": "Аккаунта " & $username & " нет в справочнике DocHub",
                "bu": "Наименование организации неопределенно",
                "error" : true
              };
          )
      :
          {
              "name": "Аккаунт не указан",
              "title": "Аккаунт не указан",
              "bu": "Наименование БЮ неопределенно",
              "error" : true
          };
    )

  get_hardware_resources: >
    (
      
      $DataLake := $;
      $DataLake.components.$spread().(
  
          $Node_id    := $keys()[0];
          $Node_link  := "/architect/components/" & $Node_id;
          $Node_title := *.title;
          $c_type     := *.extension.type;
  
          $DomainName   := $split($Node_id, ".", 4)~> $join('.');
          $Cluster      := $split($Node_id, ".", 3)~> $join('.');
          $organization := $split($Node_id, ".", 2)~> $join('.');
  
          $component := $;
          $component_id := $keys()[0];
  
          $component.*.parameters.(
  
              $server := $;
              $servers := $lookup($DataLake.components, $server);
              $servers := $merge([$servers, {"id": $server}]);
              $component := $lookup($DataLake.components, $component_id);
  
              {
                  "Organization_id": $organization,    
                  "Cluster_id": $Cluster,
                  "Domain_id": $DomainName,
                  "c_type": $c_type,
                  "node_id": $Node_id,
                  "node_link": $Node_link,
                  "node_title": $Node_title,
                  "server_id": $servers.id,
                  "server_name": $servers.name,
                  "server_role": $servers.role,
                  "server_link": "/architect/components/" & $servers.id,
                  "server_title": "/architect/components/" & $servers.title,
                  "server_ip": $servers.ip,
                  "server_cpu": $servers.cpu,
                  "server_ram": $servers.ram,
                  "server_storage_size_hdd_type_1": $servers.storage_size_hdd_type_1,
                  "server_storage_size_hdd_type_2": $servers.storage_size_hdd_type_2,
                  "server_storage_size_hdd_type_3": $servers.storage_size_hdd_type_3,
                  "server_isVM": $servers.isVM=true ? "Да" : "Нет"
              }
  
          );
  
      )[c_type = "Нода"];
    )
