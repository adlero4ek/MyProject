functions:
  # Пример вызова
  # $eval($FUNCTIONS.get_account,{"username": "v.lebedev", "accounts": $DICTIONARIES."accounts".parameters})
  get_account: >
    (
      $username := $.username;
      $accounts := $.accounts;
      $acc_link := "https://team.romashkagroup.ru/profile/" & $username;
      $type($username)="string"
      ?   (
          $full_account := $accounts[name=$username];
          $count($full_account) = 1
          ?   (
              $type($full_account.title)="string"
              ?
              $merge([$full_account, {"error" : false, "acc_link": $acc_link}])
              :
              {
                  "name": $username,
                  "title": $username,
                  "bu": "Наименование БЮ неопределенно",
                  "error" : true
              };
              )
          : $count($full_account) > 1
            ?
              $full_account.(
                $type($.bu) = "string"
                ? $merge([$, {"error" : false, "acc_link": $acc_link}])
              )
            :
              {
                "name": "Аккаунт не указан",
                "title": "Аккаунта " & $username & " нет в справочнике DocHub",
                "bu": "Наименование организации неопределенно",
                "error" : true
              };
          )
      :
          {
              "name": "Аккаунт не указан",
              "title": "Аккаунт не указан",
              "bu": "Наименование БЮ неопределенно",
              "error" : true
          };
    )

  get_hardware_resources: >
    (
      
      $DataLake := $;
      $DataLake.components.$spread().(
  
          $Node_id    := $keys()[0];
          $Node_link  := "/architect/components/" & $Node_id;
          $Node_title := *.title;
          $c_type     := *.extension.type;
  
          $DomainName   := $split($Node_id, ".", 4)~> $join('.');
          $Cluster      := $split($Node_id, ".", 3)~> $join('.');
          $organization := $split($Node_id, ".", 2)~> $join('.');
  
          $component := $;
          $component_id := $keys()[0];
  
          $component.*.parameters.(
  
              $server := $;
              $servers := $lookup($DataLake.components, $server);
              $servers := $merge([$servers, {"id": $server}]);
              $component := $lookup($DataLake.components, $component_id);
  
              {
                  "Organization_id": $organization,    
                  "Cluster_id": $Cluster,
                  "Domain_id": $DomainName,
                  "c_type": $c_type,
                  "node_id": $Node_id,
                  "node_link": $Node_link,
                  "node_title": $Node_title,
                  "server_id": $servers.id,
                  "server_name": $servers.name,
                  "server_role": $servers.role,
                  "server_link": "/architect/components/" & $servers.id,
                  "server_title": "/architect/components/" & $servers.title,
                  "server_ip": $servers.ip,
                  "server_cpu": $servers.cpu,
                  "server_ram": $servers.ram,
                  "server_storage_size_hdd_type_1": $servers.storage_size_hdd_type_1,
                  "server_storage_size_hdd_type_2": $servers.storage_size_hdd_type_2,
                  "server_storage_size_hdd_type_3": $servers.storage_size_hdd_type_3,
                  "server_isVM": $servers.isVM=true ? "Да" : "Нет"
              }
  
          );
  
      )[c_type = "Нода"];
    )

  get_installed_systems: >
    (
    
      $datalake := $;
      $datalake.components.$spread().(
      
        $server_id  := $keys()[0];
        $server     := $lookup($datalake.components, $server_id);
        
        $node_id    := $split($server_id, ".", 5)~> $join('.');
        $node       := $lookup($datalake.components, $node_id);
        
        $domain_id  := $split($server_id, ".", 4)~> $join('.');
        $domain     := $lookup($datalake.components, $domain_id);
        
        $cluster_id := $split($server_id, ".", 3)~> $join('.');
        $cluster    := $lookup($datalake.components, $cluster_id);
        
        *.installed_systems.(
          {
            "system_id": system_id,
            
            "server_id": $server_id,
            "server_title": $server.name & "\n(" & $server.role & ")\nIP:" & $server.ip,
            "server_link": "/architect/components/" & $server_id,
    
            "server_name": $server.name,
            "server_role": $server.role,
            "server_IP": $server.ip,
    
            "db_name": db_name,
            "description": description,
            
            "cluster_title": $cluster.title,
            "cluster_id": $cluster_id,
            "cluster_link": "/entities/extended_application_card/extended_card_cluster?id=" & $cluster_id,
            
            "domain_title": $domain.title,
            "domain_link": "/entities/extended_application_card/extended_card_functional_cluster?id=" & $domain_id,
            "domain_id": $domain_id,
            
            "node_title": $node.title,
            "node_link": "/entities/extended_application_card/extended_card_node?id=" & $node_id,
            "node_id": $node_id,
            
            "system_title": $lookup($datalake.components, system_id).title,
            "system_link": "/entities/extended_application_card/blank?id=" & system_id
          
          }
        )
      )
    )
    

  get_sequence_diagrams_list: >
      (
        $DataLake := $;
        $SequenceDiagrams := $DataLake.SequenceDiagrams;

        $SequenceDiagrams.$spread().(

          $Diagram_Id := $keys()[0];
          $Diagram    := $lookup($SequenceDiagrams, $Diagram_Id);
          $System     := $lookup($DataLake.components, $Diagram.system);
          $Subsystem  := $lookup($DataLake.components, $Diagram.sybsytem);

          {

            "Diagram_id": $Diagram_Id,
            "Diagram_title": $Diagram.title,
            "Diagram_link": "/entities/SequenceDiagrams/blank?id=" & $Diagram_Id,
            "Diagram_isgroup": $Diagram.isgroup,
            "Diagram_code": $Diagram.code,
            "Diagram_description": $Diagram.description,
            "System_id": $Diagram.system,
            "System_link": "/entities/extended_application_card/blank?id=" & $Diagram.system,
            "System_Title": $System.title,
            "SybSystem_id": $Diagram.sybsytem,
            "SybSystem_link": "/entities/extended_application_card/blank?id=" & $Diagram.sybsytem,
            "SybSystem_Title": $Subsystem.title,
            "Diagram_input": $Diagram.input,
            "Diagram_output": $Diagram.output     
          }

        )[Diagram_isgroup=false]^(Diagram_code)
      )

  # $eval($FUNCTIONS.get_quality_features,{"feature": "total_cpu"})
  # Варианты feature описаны в методе $GetTotal

  # $eval($.functions.get_quality_features,{"feature": "total_cpu", "query": $query, "components": components});
  # Варианты feature описаны в методе $GetTotal
  get_quality_features: >
    (

     $GetColor := function($x) {(

        $contains($x, ".Dev") ? "green" :
          $contains($x, ".Prod") ? "lightblue" :
            $contains($x, ".Test") ? "orange" :
              $contains($x, ".Stage") ? "pink" : "red"

      )};

      $GetTotal := function($x, $c) {(

        $x = "total_cpu" ? $c{`Cluster_id`: $sum(server_cpu)} :
          $x = "total_ram" ? $c{`Cluster_id`: $sum(server_ram)} :
            $x = "total_nodes" ? $c{`Cluster_id`: $count($distinct(node_id))} :
              $x = "total_servers" ? $c{`Cluster_id`: $count($distinct(server_id))} :
                $x = "total_size_hdd_type_1" ? $c{`Cluster_id`: $sum(server_storage_size_hdd_type_1)} :
                  $x = "total_size_hdd_type_2" ? $c{`Cluster_id`: $sum(server_storage_size_hdd_type_2)} :
                    $x = "total_size_hdd_type_3" ? $c{`Cluster_id`: $sum(server_storage_size_hdd_type_3)} : 0

        )};

      $feature    := $.feature;
      $query      := $.query;
      $components := $.components;
      $Clusters   := $distinct($query.Cluster_id);

      {
        "datasets": 

            $Clusters.(

              $Cluster_id := $;
              $Cluster := $lookup($components, $Cluster_id);

              {
                "label": $Cluster.title,      
                "backgroundColor": $GetColor($Cluster_id),
                "data":[$lookup($GetTotal($feature, $query), $Cluster_id)]
              }

           )
      }

    )
    

#    components.$spread().(
#    
#    $system_id := $keys()[0];
#
#    *.aspects.(
#
#        $aspect_id := $;
#
#        {
#            "system_id": $system_id,
#            "aspect_id":  $aspect_id,
#            "aspect_title": $lookup($DataLake.aspects, $aspect_id).title,
#            "aspect_link": "/architect/aspects/" & $aspect_id
#        }
#    );
#    )