entities:

  extended_application_card:
    title: Расширенная карточка информационной системы/сервиса
    description: ""
    presentations:
      blank:
        title: Расширенная карточка информационной системы/сервиса
        type: markdown
        template: extended_card_application.md
        source: >
          (

              $id := $params.id;
              
              $IsDomain := $count($split($id, ".")) = 3;
              $DomainName := $split($id, ".", 3)~> $join('.');
              
              $count_sequence := $count($eval($.functions.get_sequence_diagrams_list)[System_id=$id]);              

              $query_count_app_data_obj := $.ApplicationDataObjects.$spread().(
                $.*.{
                  "system_id": system,
                  "count_app": system=$id ? 1 : 0,
                  "count_domain": $contains(system, $DomainName) ? 1 : 0
                }
              )[system_id=$id or $contains(system_id, $DomainName)]; 
          
              $query_count_links := links.$spread().(
                $.*.{
                  "count_to": $contains(to, $id) ? 1 : 0,
                  "count_from": $contains(from, $id) ? 1 : 0
                }
              );
          
              components.$spread().(
              
                $link_id := $keys()[0];
            
                $.*.{
                  "id": $link_id,
                  "id_link": "/architect/components/" & $link_id,
                  "title": title,
                  "entity": entity,
                  "description": description,
                  "type": extension.type,
                  "area": extension.area,
                  "state": extension.state,
                  "state_update_date": extension.state_update_date,
                  "development_platform": extension.development_platform,
                  "basic_solution": extension.basic_solution,
                  "basic_solution_link": extension.basic_solution_link,
                  "basic_solution_state": extension.basic_solution_state,
                  "provider": extension.provider,
                  "provider_type": extension.provider_type,
                  "count_app_data_obj": $IsDomain = true ? $sum($query_count_app_data_obj.count_domain) : $sum($query_count_app_data_obj.count_app),
                  "count_links_from": $sum($query_count_links.count_from),
                  "count_links_to": $sum($query_count_links.count_to),
                  "count_sequence": $count_sequence
                }
          
              )[id=$params.id]
     
          )
      extended_card_node:
        title: Расширенная карточка Ноды
        type: markdown
        template: extended_card_node.md
        source: >
          (
              $id := $params.id;
              $node := $lookup($.components, $id);
              
              $Domain_id := $split($id, ".", 4)~> $join('.');
              $Domain_title := $lookup($.components, $Domain_id).title;
          
              $Cluster_id := $split($id, ".", 3)~> $join('.');              
              $Cluster_title := $lookup($.components, $Cluster_id).title;
          
              {
                "Cluster_id": $Cluster_id,
                "Cluster_title": $Cluster_title,                
                "domain_id": $Domain_id,                
                "domain_title": $Domain_title,
                "node_id": $id,
                "node_link": "/architect/components/" & $id,
                "node_title": $node.title,
                "node_description": $node.description
              }
          )
      extended_card_cluster:
        title: Расширенная карточка кластера
        type: markdown
        template: extended_card_cluster.md
        source: >
          (
          
             $id := $params.id;
             $Cluster := $lookup($.components, $id);
    
             {
               "Contur_id": $split($id, ".", 2)~> $join('.'),                
               "Cluster_id": $id,
               "Cluster_link": "/architect/components/" & $id,
               "Cluster_title": $Cluster.title,
               "Cluster_description": $Cluster.description
             }
          
          )
      extended_card_functional_cluster:
        title: Расширенная карточка функционального кластера
        type: markdown
        template: extended_card_functional_cluster.md
        source: >
          (
          
              $id := $params.id;
              $Domain := $lookup($.components, $id);
              $Cluster_id := $split($id, ".", 3)~> $join('.');              
              $Cluster_title := $lookup($.components, $Cluster_id).title;

              {
                "Cluster_id": $Cluster_id,                
                "Cluster_title": $Cluster_title,
                "Domain_id": $id,
                "Domain_link": "/architect/components/" & $id,
                "Domain_title": $Domain.title,
                "Domain_description": $Domain.description
              }
          
          )